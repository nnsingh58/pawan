<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Plan your travel across India with bus stand routes and fare estimates.">
    <meta name="keywords" content="Travel Planner, Bus Routes, Fare Estimate, India Travel">
    <title>India Travel Planner - Plan Your Ride</title>
    <link rel="icon" href="data:,">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { padding: 10px; background: #f0f2f5; min-height: 100vh; }
        .container { max-width: 100%; margin: 0 auto; padding: 0 10px; }
        .header { text-align: center; padding: 1.5rem; background: linear-gradient(90deg, #2563eb, #1e40af); color: white; border-radius: 10px; margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
        .header h1 { font-size: clamp(20px, 4vw, 28px); }
        .header p { font-size: clamp(12px, 2.5vw, 16px); margin-top: 5px; }
        .search-box { background: white; padding: 1rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); margin-bottom: 1.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; }
        input { flex: 1; padding: 8px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: clamp(12px, 2.5vw, 16px); min-width: 200px; }
        input:focus { border-color: #2563eb; outline: none; }
        button { padding: 8px 16px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: transform 0.3s; font-size: clamp(12px, 2.5vw, 16px); }
        button:hover { transform: scale(1.05); }
        .list-btn { background: linear-gradient(45deg, #00c4cc, #007bff); color: white; }
        .search-btn { background: linear-gradient(45deg, #ff6f61, #ff9f1c); color: white; }
        .danger-btn { background: linear-gradient(45deg, #dc3545, #ff6b6b); color: white; margin: 1rem auto; display: block; }
        #map { height: 400px; width: 100%; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); margin-bottom: 1.5rem; }
        .card-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; }
        .card-container p { background: white; padding: 1rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); font-size: clamp(12px, 2.5vw, 16px); }
        .fare-estimate { text-align: center; font-size: clamp(14px, 3vw, 18px); color: #007bff; margin-bottom: 1rem; }
        .fare-details { background: white; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .custom-fare { text-align: center; margin-bottom: 1.5rem; }
        .custom-fare input { width: 120px; margin-right: 0.5rem; }
        .custom-fare button { padding: 8px 16px; background: linear-gradient(45deg, #28a745, #20c997); color: white; }
        .error-warning { background: #f8d7da; color: #721c24; padding: 0.5rem; border-radius: 5px; margin-bottom: 0.5rem; text-align: center; font-size: clamp(12px, 2.5vw, 16px); }
        .loading { display: inline-block; width: 16px; height: 16px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 768px) { 
            .search-box { flex-direction: column; align-items: stretch; }
            input { width: 100%; }
            #map { height: 300px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>India Travel Planner</h1>
            <p>Plan your route and start your journey</p>
        </div>

        <div class="search-box">
            <input type="text" id="start" placeholder="Start Bus Stand (e.g., Ghaziabad Bus Stand)">
            <input type="text" id="end" placeholder="Destination Bus Stand (e.g., Meerut Bus Stand)">
            <button id="listRideBtn" class="list-btn">
                <span id="listRideText">List Ride</span>
                <span id="listRideLoader" class="loading" style="display:none;"></span>
            </button>
            <button id="searchRideBtn" class="search-btn">
                <span id="searchRideText">Search Ride</span>
                <span id="searchRideLoader" class="loading" style="display:none;"></span>
            </button>
        </div>

        <div id="map"></div>
        <div id="fare-estimate" class="fare-estimate"></div>
        <div id="fare-details" class="fare-details"></div>
        <div class="custom-fare">
            <input type="number" id="custom-fare" placeholder="Set your fare (₹)">
            <button id="publishRideBtn">
                <span id="publishRideText">Publish Ride</span>
                <span id="publishRideLoader" class="loading" style="display:none;"></span>
            </button>
        </div>
        <div id="ride-list" class="card-container"></div>
        <div class="card-container" id="ride-history" style="margin-top: 1.5rem;"></div>
        <button id="reportBtn" class="danger-btn">Report Emergency</button>
    </div>

    <script>
        (function() {
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyDh-GVPjb6y9iig7Mzgq0K2Ps2duNSRpKU&libraries=advanced-markers&callback=initMap';
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        })();

        let map = null;
        let directionsRenderer = null;
        let rides = [];
        let rideHistory = [];
        const RATE_PER_KM = 3;
        const AVG_SPEED_KMH = 60;
        let liveMarker = null;
        let busStops = [];

        const elements = {
            startInput: document.getElementById('start'),
            endInput: document.getElementById('end'),
            customFareInput: document.getElementById('custom-fare'),
            fareEstimate: document.getElementById('fare-estimate'),
            fareDetails: document.getElementById('fare-details'),
            rideList: document.getElementById('ride-list'),
            rideHistory: document.getElementById('ride-history'),
            listRideBtn: document.getElementById('listRideBtn'),
            searchRideBtn: document.getElementById('searchRideBtn'),
            publishRideBtn: document.getElementById('publishRideBtn'),
            reportBtn: document.getElementById('reportBtn')
        };

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 5,
                center: { lat: 20.5937, lng: 78.9629 }
            });
            directionsRenderer = new google.maps.DirectionsRenderer({ map: map });
            startLiveTracking();
            fetchBusStops();
        }

        function fetchBusStops() {
            fetch('https://overpass-api.de/api/interpreter', {
                method: 'POST',
                body: '[out:json];node["highway"="bus_stop"](20.5937, 68.9629, 35.0, 97.0);out body;'
            })
            .then(response => response.json())
            .then(data => {
                busStops = data.elements;
                console.log('Bus Stops Fetched:', busStops);
                // बस स्टॉप्स को मानचित्र पर दिखाने के लिए
                busStops.forEach(stop => {
                    new google.maps.marker.AdvancedMarkerElement({
                        position: { lat: stop.lat, lng: stop.lon },
                        map: map,
                        title: stop.tags.name || 'Bus Stop'
                    });
                });
            })
            .catch(error => {
                console.error('Overpass API Error:', error);
                showError('Failed to fetch bus stops');
            });
        }

        function startLiveTracking() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        const pos = { lat: position.coords.latitude, lng: position.coords.longitude };
                        if (liveMarker) {
                            liveMarker.position = pos;
                        } else {
                            liveMarker = new google.maps.marker.AdvancedMarkerElement({
                                position: pos,
                                map: map,
                                title: 'Your Current Location',
                                content: new google.maps.marker.PinElement({
                                    background: '#0000FF',
                                    borderColor: '#0000FF',
                                    glyphColor: '#FFFFFF'
                                }).element
                            });
                        }
                        map.setCenter(pos);
                    },
                    (error) => {
                        console.error('Live Tracking Error:', error);
                        showError('Error fetching live location');
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                showError('Your browser does not support live tracking');
            }
        }

        function formatTime(hours) {
            const hrs = Math.floor(hours);
            const mins = Math.round((hours - hrs) * 60);
            return `${hrs} hours ${mins} minutes`;
        }

        const geocodeCache = {};
        async function geocode(location) {
            if (geocodeCache[location]) return geocodeCache[location];
            try {
                const query = location.toLowerCase().includes('bus stand') ? location : `${location} Bus Stand`;
                const geocoder = new google.maps.Geocoder();
                return new Promise((resolve, reject) => {
                    geocoder.geocode({ address: query, region: 'IN' }, (results, status) => {
                        if (status === google.maps.GeocoderStatus.OK && results[0]) {
                            const result = {
                                lat: results[0].geometry.location.lat(),
                                lng: results[0].geometry.location.lng(),
                                name: results[0].address_components[0].long_name
                            };
                            geocodeCache[location] = result;
                            resolve(result);
                        } else {
                            reject(new Error(`Location not found: ${location}`));
                        }
                    });
                });
            } catch (error) {
                console.error('Geocoding Error:', error);
                return null;
            }
        }

        async function updateMapRoute(startCoords, endCoords) {
            const directionsService = new google.maps.DirectionsService();
            directionsService.route(
                {
                    origin: { lat: startCoords.lat, lng: startCoords.lng },
                    destination: { lat: endCoords.lat, lng: endCoords.lng },
                    travelMode: google.maps.TravelMode.DRIVING
                },
                (result, status) => {
                    if (status === google.maps.DirectionsStatus.OK) {
                        directionsRenderer.setDirections(result);
                    } else {
                        showError('Error displaying route');
                    }
                }
            );
        }

        async function calculateRoute() {
            const start = elements.startInput.value.trim();
            const end = elements.endInput.value.trim();
            if (!start || !end) {
                showError('Please enter start and destination bus stands');
                return { distance: 0, naturalFare: 0, time: 0, cities: [], startCoords: null, endCoords: null };
            }

            toggleLoading(true);
            try {
                const startCoords = await geocode(start);
                const endCoords = await geocode(end);
                if (!startCoords || !endCoords) throw new Error('Location coordinates not found');

                const directionsService = new google.maps.DirectionsService();
                const routePromise = new Promise((resolve, reject) => {
                    directionsService.route(
                        {
                            origin: { lat: startCoords.lat, lng: startCoords.lng },
                            destination: { lat: endCoords.lat, lng: endCoords.lng },
                            travelMode: google.maps.TravelMode.DRIVING
                        },
                        (result, status) => {
                            if (status === google.maps.DirectionsStatus.OK) {
                                resolve(result);
                            } else {
                                reject(new Error('Route calculation failed'));
                            }
                        }
                    );
                });

                const result = await routePromise;
                const route = result.routes[0].legs[0];
                const roadDistance = route.distance.value / 1000;
                const naturalFare = Math.round(roadDistance * RATE_PER_KM);
                const time = roadDistance / AVG_SPEED_KMH;

                return { distance: roadDistance, naturalFare, time, cities: [startCoords.name, endCoords.name], startCoords, endCoords };
            } catch (error) {
                console.error('Route Calculation Error:', error);
                showError(`Route calculation failed: ${error.message}`);
                return { distance: 0, naturalFare: 0, time: 0, cities: [], startCoords: null, endCoords: null };
            } finally {
                toggleLoading(false);
            }
        }

        async function listRide() {
            const result = await calculateRoute();
            if (result.distance > 0) {
                updateMapRoute(result.startCoords, result.endCoords);
                elements.fareEstimate.innerHTML = `
                    <div>Estimated Fare: ₹${result.naturalFare}</div>
                    <div>Distance: ${result.distance.toFixed(2)} km</div>
                    <div>Time: ${formatTime(result.time)}</div>
                    <div>Cities on Route: ${result.cities[0]} to ${result.cities[1]}</div>
                `;
                elements.rideList.innerHTML = '';
            }
        }

        async function searchRide() {
            const result = await calculateRoute();
            if (result.distance > 0) {
                updateMapRoute(result.startCoords, result.endCoords);
                elements.fareEstimate.innerHTML = `
                    <div>Estimated Fare: ₹${result.naturalFare}</div>
                    <div>Distance: ${result.distance.toFixed(2)} km</div>
                    <div>Time: ${formatTime(result.time)}</div>
                    <div>Cities on Route: ${result.cities[0]} to ${result.cities[1]}</div>
                `;
                const start = elements.startInput.value.trim();
                const end = elements.endInput.value.trim();
                const filteredRides = rides.filter(ride => 
                    ride.start.toLowerCase() === start.toLowerCase() && 
                    ride.end.toLowerCase() === end.toLowerCase()
                );
                displayRides(filteredRides);
            }
        }

        async function publishRide() {
            const start = elements.startInput.value.trim();
            const end = elements.endInput.value.trim();
            const customFare = parseInt(elements.customFareInput.value.trim());

            if (!start || !end) {
                showError('Please enter start and destination bus stands');
                return;
            }
            if (!customFare || customFare <= 0) {
                showError('Please set a valid fare');
                return;
            }

            const result = await calculateRoute();
            if (result.distance === 0) return;

            updateMapRoute(result.startCoords, result.endCoords);
            const naturalFare = result.naturalFare;
            const percentageDiff = Math.round(((customFare - naturalFare) / naturalFare) * 100);
            const actualFare = Math.round(naturalFare + (naturalFare * (percentageDiff / 100)));

            elements.fareDetails.innerHTML = `
                <h3>Fare Details</h3>
                <p>Natural Fare (₹${RATE_PER_KM}/km): ₹${naturalFare}</p>
                <p>Your Proposed Fare: ₹${customFare} (${percentageDiff >= 0 ? '+' : ''}${percentageDiff}%)</p>
                <p>Final Fare: ₹${actualFare}</p>
            `;

            const ride = {
                start,
                end,
                customFare,
                naturalFare,
                percentageDiff,
                actualFare,
                distance: result.distance,
                timestamp: new Date().toLocaleString('en-IN')
            };

            rides.push(ride);
            rideHistory.push(ride);
            displayRides(rides);
            displayHistory(rideHistory);
        }

        function toggleLoading(isLoading) {
            ['listRide', 'searchRide', 'publishRide'].forEach(btn => {
                const text = document.getElementById(`${btn}Text`);
                const loader = document.getElementById(`${btn}Loader`);
                text.style.display = isLoading ? 'none' : 'inline';
                loader.style.display = isLoading ? 'inline-block' : 'none';
            });
        }

        function showError(message) {
            elements.fareEstimate.innerHTML = `<div class="error-warning">${message}</div>`;
        }

        function displayRides(ridesToShow) {
            elements.rideList.innerHTML = ridesToShow.length ?
                ridesToShow.map(ride => `
                    <p>
                        ${ride.start} to ${ride.end}<br>
                        Fare: ₹${ride.actualFare}<br>
                        (Natural: ₹${ride.naturalFare}, ${ride.percentageDiff >= 0 ? '+' : ''}${ride.percentageDiff}%)<br>
                        Road Route
                    </p>
                `).join('') :
                '<p>No rides available</p>';
        }

        function displayHistory(history) {
            elements.rideHistory.innerHTML = history.length ?
                history.map(ride => `
                    <p>
                        ${ride.timestamp}<br>
                        ${ride.start} to ${ride.end}<br>
                        Fare: ₹${ride.actualFare}<br>
                        (Natural: ₹${ride.naturalFare}, ${ride.percentageDiff >= 0 ? '+' : ''}${ride.percentageDiff}%)<br>
                        Road Route
                    </p>
                `).join('') :
                '<p>No ride history</p>';
        }

        function reportEmergency() {
            const issue = prompt('Enter emergency details:');
            if (issue) alert('Emergency reported to admin!');
        }

        function initApp() {
            elements.listRideBtn.addEventListener('click', listRide);
            elements.searchRideBtn.addEventListener('click', searchRide);
            elements.publishRideBtn.addEventListener('click', publishRide);
            elements.reportBtn.addEventListener('click', reportEmergency);
        }

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });
    </script>
</body>
</html>
